<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>SDA Jaksel - Spatial Analyzer</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        :root { --navy: #0f172a; --gold: #f59e0b; }
        body { margin: 0; padding: 0; font-family: 'Segoe UI', sans-serif; display: flex; height: 100vh; }
        #sidebar { width: 380px; background: white; border-right: 4px solid var(--gold); display: flex; flex-direction: column; z-index: 1001; }
        .sidebar-header { background: var(--navy); color: white; padding: 20px; }
        .sidebar-content { padding: 20px; flex-grow: 1; overflow-y: auto; background: #f8fafc; }
        .upload-box { border: 2px dashed #cbd5e1; padding: 15px; text-align: center; border-radius: 12px; }
        #summary { background: #e0f2fe; padding: 15px; border-radius: 10px; margin-top: 15px; display: none; border: 1px solid #bae6fd; }
        .st-card { background: white; padding: 12px; border-radius: 8px; margin-bottom: 10px; border-left: 5px solid var(--gold); box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        #map { flex-grow: 1; height: 100vh; }
    </style>
</head>
<body>

<div id="sidebar">
    <div class="sidebar-header">
        <h2>SPATIAL ANALYZER</h2>
        <div style="font-size: 0.7rem; color: var(--gold);">Sudin SDA Jakarta Selatan</div>
    </div>
    <div class="sidebar-content">
        <h3>1. Upload Catchment</h3>
        <div class="upload-box">
            <input type="file" id="upload-geojson" accept=".geojson">
        </div>

        <div id="summary">
            <div style="font-size: 0.75rem;">Rerata Hujan Wilayah:</div>
            <div id="result-val" style="font-size: 2rem; font-weight: 800; color: #0369a1;">0 mm</div>
        </div>

        <h3>2. Detail Stasiun Pengaruh</h3>
        <div id="list-area"></div>
    </div>
</div>
<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.9.0/proj4.js"></script>
<script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>

<script>
    const script = document.createElement('script');
    // Menambahkan timestamp unik agar browser tidak mengambil data cache lama
    script.src = 'data-stasiun.js?v=' + new Date().getTime();
    document.head.appendChild(script);

    script.onload = function() {
        console.log("Database stasiun berhasil dimuat!");
        initMap();
    };
</script>

<script>
    const UTM_48S = "+proj=utm +zone=48 +south +datum=WGS84 +units=m +no_defs";
    const WGS84 = "+proj=longlat +datum=WGS84 +no_defs";
    let map, analysisGroup, catchmentLayer;

    function initMap() {
        map = L.map('map').setView([-6.28, 106.81], 11);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
        analysisGroup = L.layerGroup().addTo(map);

        // Plot semua stasiun dari data-stasiun.js
        STASIUN_DATABASE.forEach(st => {
            L.circleMarker([st.lat, st.lng], { radius: 5, color: 'red' }).addTo(map).bindPopup(st.nama);
        });
    }

    document.getElementById('upload-geojson').addEventListener('change', function(e) {
        const reader = new FileReader();
        reader.onload = (event) => processGeoJSON(JSON.parse(event.target.result));
        reader.readAsText(e.target.files[0]);
    });

    function processGeoJSON(geojson) {
        analysisGroup.clearLayers();
        if(catchmentLayer) map.removeLayer(catchmentLayer);

        catchmentLayer = L.geoJSON(geojson, {
            coordsToLatLng: function(coords) {
                if (Math.abs(coords[0]) > 1000) {
                    const p = proj4(UTM_48S, WGS84, [coords[0], coords[1]]);
                    return new L.LatLng(p[1], p[0]);
                }
                return new L.LatLng(coords[1], coords[0]);
            }
        }).addTo(map);
        map.fitBounds(catchmentLayer.getBounds());

        let poly = geojson.features ? geojson.features[0] : geojson;
        if (poly.geometry.coordinates[0][0][0] > 1000) {
            poly = turf.rewind(turf.transformCoord(poly, UTM_48S, WGS84));
        }

        calculateThiessen(poly);
    }

    function calculateThiessen(poly) {
        const pts = STASIUN_DATABASE.map(st => turf.point([st.lng, st.lat], st));
        const bbox = turf.bbox(poly);
        const voronoi = turf.voronoi(turf.featureCollection(pts), { bbox: [bbox[0]-0.2, bbox[1]-0.2, bbox[2]+0.2, bbox[3]+0.2] });

        let totalWeight = 0, totalArea = 0;
        const listArea = document.getElementById('list-area');
        listArea.innerHTML = "";

        voronoi.features.forEach((v, i) => {
            const intersection = turf.intersect(v, poly);
            if (intersection) {
                const area = turf.area(intersection) / 10000; // Ha
                const st = pts[i].properties;
                
                totalWeight += (st.hujan * area);
                totalArea += area;

                L.geoJSON(intersection, { style: { color: 'orange', fillOpacity: 0.3 } }).addTo(analysisGroup);

                listArea.innerHTML += `
                    <div class="st-card">
                        <b>${st.nama}</b><br>
                        Hujan: ${st.hujan} mm<br>
                        <small>Luas: ${area.toFixed(2)} Ha</small>
                    </div>`;
            }
        });

        const rerata = totalArea > 0 ? totalWeight / totalArea : 0;
        document.getElementById('summary').style.display = 'block';
        document.getElementById('result-val').innerText = rerata.toFixed(2) + " mm";
    }
</script>
</body>
</html>
