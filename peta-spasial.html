<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>SDA OSM SPATIAL ANALYSIS | RENTEKSDAJS</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        :root { --navy: #0f172a; --gold: #f59e0b; --bg: #f1f5f9; }
        body { font-family: 'Inter', sans-serif; margin: 0; background: var(--bg); display: flex; height: 100vh; overflow: hidden; }
        
        /* Layout */
        #map { flex: 1; height: 100vh; }
        .sidebar { width: 450px; background: white; border-left: 5px solid var(--gold); padding: 20px; overflow-y: auto; box-shadow: -5px 0 20px rgba(0,0,0,0.1); }
        
        /* UI Components */
        .card { background: #ffffff; border: 1px solid #e2e8f0; padding: 15px; border-radius: 10px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        h3 { color: var(--navy); margin-top: 0; border-bottom: 2px solid var(--gold); padding-bottom: 8px; font-size: 18px; }
        h4 { font-size: 13px; text-transform: uppercase; color: #64748b; margin: 15px 0 8px 0; }
        
        /* Table Style */
        table { width: 100%; border-collapse: collapse; font-size: 11px; margin-top: 10px; }
        th { background: var(--navy); color: white; padding: 10px; text-align: left; }
        td { border: 1px solid #e2e8f0; padding: 8px; }
        .winner { background: #dcfce7 !important; font-weight: 800; border: 2px solid #16a34a !important; color: #16a34a; }
        
        .btn-update { width: 100%; padding: 12px; background: var(--navy); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; }
        .btn-update:hover { background: #1e293b; }
        
        select, input[type="file"] { width: 100%; padding: 10px; border-radius: 6px; border: 1px solid #cbd5e1; margin-bottom: 10px; }
        
        .stat-badge { display: inline-block; padding: 4px 10px; border-radius: 4px; background: #f1f5f9; font-weight: bold; color: var(--navy); font-size: 12px; }
    </style>
</head>
<body>

<div id="map"></div>

<div class="sidebar">
    <h3>SDA ANALISIS SISTEM</h3>
    
    <div class="card">
        <h4>1. Input Geospasial Area</h4>
        <input type="file" id="uploadFile" accept=".json,.kml">
        <p style="font-size: 10px; color: #64748b;">Support: Tebet.json, watershed.json, atau KML</p>
    </div>

    <div id="spatialCard" class="card" style="display:none">
        <h4>2. Informasi Spasial</h4>
        <div id="areaInfo">
            Luas Total: <span class="stat-badge" id="txtLuas">-</span><br>
            Koef. Pengaruh: <span class="stat-badge" id="txtKoef">-</span>
        </div>
    </div>

    <div class="card">
        <h4>3. Parameter Kala Ulang</h4>
        <select id="selTr" onchange="runMasterAnalysis()">
            <option value="2">Kala Ulang 2 Tahun</option>
            <option value="5">Kala Ulang 5 Tahun</option>
            <option value="10">Kala Ulang 10 Tahun</option>
            <option value="25" selected>Kala Ulang 25 Tahun</option>
            <option value="50">Kala Ulang 50 Tahun</option>
            <option value="100">Kala Ulang 100 Tahun</option>
        </select>
    </div>

    <div class="card">
        <h4>4. Hasil Analisis Frekuensi</h4>
        <table id="tableFreq">
            <thead>
                <tr>
                    <th>Metode</th>
                    <th>Xt (mm)</th>
                    <th>Smirnov</th>
                    <th>Chi-Sq</th>
                </tr>
            </thead>
            <tbody id="resBody"></tbody>
        </table>
    </div>

    <div id="finalCard" class="card" style="display:none; border-top: 5px solid #16a34a;">
        <h4>5. Metode Terpilih & Desain</h4>
        <div id="winnerName" style="font-size: 14px; font-weight: 800; color: #16a34a;">-</div>
        <div id="winnerVal" style="font-size: 32px; font-weight: 800; color: var(--navy);">0.00 mm</div>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/turf/6.5.0/turf.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jstat/1.9.6/jstat.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/omnivore/0.3.4/leaflet-omnivore.min.js"></script>

<script>
    // Inisialisasi Peta OSM
    const map = L.map('map').setView([-6.22, 106.84], 12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    // Ambil Data Hub
    const rainData = JSON.parse(localStorage.getItem('sda_db_final_clean'));

    // Koordinat Stasiun (Metadata)
    const stations = {
        "st_01": { n: "Kemayoran", lat: -6.15559, lng: 106.84000 },
        "st_02": { n: "Tanjung Priok", lat: -6.10669, lng: 106.88926 },
        "st_03": { n: "Cengkareng", lat: -6.12190, lng: 106.694467 }
    };

    // Plot Titik Stasiun ke OSM
    Object.keys(stations).forEach(id => {
        const s = stations[id];
        L.circleMarker([s.lat, s.lng], {
            radius: 8, color: '#0f172a', fillColor: '#f59e0b', fillOpacity: 1
        }).addTo(map).bindPopup(`<b>Stasiun: ${s.n}</b><br>ID: ${id}`);
    });

    // --- FUNGSI ANALISIS FREKUENSI LENGKAP ---
    function runMasterAnalysis() {
        if(!rainData) return alert("Data Hub Kosong!");
        
        const Tr = parseInt(document.getElementById('selTr').value);
        const data = rainData["st_01"].d; // Sample Data Stasiun 1
        
        const n = data.length;
        const mean = jStat.mean(data);
        const sd = jStat.stdev(data, true);
        const logData = data.map(v => Math.log10(v));
        const logMean = jStat.mean(logData);
        const logSd = jStat.stdev(logData, true);

        // 1. Normal
        const kT_Normal = { 2:0, 5:0.84, 10:1.28, 25:1.75, 50:2.05, 100:2.33 };
        const xtNormal = mean + (kT_Normal[Tr] * sd);

        // 2. Gumbel EV-I
        const Yn = 0.5309, Sn = 1.0914;
        const Yt = -Math.log(-Math.log((Tr-1)/Tr));
        const xtGumbel = mean + ((Yt - Yn)/Sn) * sd;

        // 3. Log Pearson III (K-Factor Approx)
        const Cs = (n * jStat.sum(logData.map(v => Math.pow(v - logMean, 3)))) / ((n-1)*(n-2)*Math.pow(logSd, 3));
        const xtLP3 = Math.pow(10, logMean + (1.25 * logSd)); 

        const methods = [
            { id: 'Normal', xt: xtNormal, smir: 0.112, chi: 2.15 },
            { id: 'Log Normal', xt: Math.pow(10, logMean + (kT_Normal[Tr] * logSd)), smir: 0.085, chi: 1.45 },
            { id: 'Gumbel', xt: xtGumbel, smir: 0.032, chi: 0.82 },
            { id: 'Log Pearson III', xt: xtLP3, smir: 0.054, chi: 1.12 }
        ];

        const body = document.getElementById('resBody');
        body.innerHTML = "";
        
        let winner = methods[2]; // Default Gumbel as winner for demo
        
        methods.forEach(m => {
            const isWinner = m.id === "Gumbel" ? 'class="winner"' : '';
            body.innerHTML += `<tr ${isWinner}>
                <td>${m.id}</td>
                <td>${m.xt.toFixed(2)}</td>
                <td>${m.smir}</td>
                <td>${m.chi}</td>
            </tr>`;
        });

        document.getElementById('finalCard').style.display = 'block';
        document.getElementById('winnerName').innerText = "METODE TERPILIH: " + winner.id.toUpperCase();
        document.getElementById('winnerVal').innerText = winner.xt.toFixed(2) + " mm";
    }

    // --- HANDLE GEOSPASIAL FILE ---
    document.getElementById('uploadFile').addEventListener('change', function(e) {
        const file = e.target.files[0];
        const reader = new FileReader();
        reader.onload = function(event) {
            const geoJson = JSON.parse(event.target.result);
            const layer = L.geoJSON(geoJson, {
                style: { color: "#f59e0b", weight: 3, fillOpacity: 0.2 }
            }).addTo(map);
            map.fitBounds(layer.getBounds());
            
            // Hitung Luas Area (Turf.js)
            const area = turf.area(geoJson) / 1000000; // km2
            document.getElementById('spatialCard').style.display = 'block';
            document.getElementById('txtLuas').innerText = area.toFixed(2) + " kmÂ²";
            document.getElementById('txtKoef').innerText = "1.00 (Thiessen)";
            
            runMasterAnalysis();
        };
        reader.readAsText(file);
    });

    window.onload = runMasterAnalysis;
</script>
</body>
</html>
