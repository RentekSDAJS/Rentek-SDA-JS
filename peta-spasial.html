<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>SDA Jaksel - Hydro-Spatial Analyst PRO</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        :root { --primary: #0f172a; --accent: #f59e0b; --success: #10b981; --danger: #ef4444; }
        body { margin: 0; display: flex; height: 100vh; font-family: 'Inter', 'Segoe UI', sans-serif; background: #f8fafc; overflow: hidden; }
        
        #sidebar { width: 620px; background: white; padding: 20px; overflow-y: auto; box-shadow: 4px 0 15px rgba(0,0,0,0.1); z-index: 1000; }
        #map { flex: 1; z-index: 1; }

        .status-bar { padding: 10px; border-radius: 8px; font-size: 0.8rem; font-weight: 800; text-align: center; margin-bottom: 20px; text-transform: uppercase; }
        .status-online { background: #dcfce7; color: #15803d; border: 1px solid #22c55e; }
        .status-offline { background: #fee2e2; color: #b91c1c; border: 1px solid #ef4444; }

        h2 { color: var(--primary); border-left: 6px solid var(--accent); padding-left: 15px; font-size: 1.2rem; margin: 0 0 25px 0; }
        .section-title { background: #f1f5f9; padding: 8px 12px; border-radius: 6px; color: #334155; font-weight: 700; margin-top: 20px; font-size: 0.85rem; display: flex; justify-content: space-between; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.75rem; border: 1px solid #e2e8f0; }
        th { background: #f8fafc; padding: 10px; border: 1px solid #e2e8f0; color: #64748b; }
        td { padding: 8px; border: 1px solid #e2e8f0; text-align: center; color: #1e293b; }
        
        .result-card { background: #ecfdf5; border: 2px solid var(--success); padding: 20px; border-radius: 12px; text-align: center; margin-top: 15px; }
        .tag { padding: 3px 8px; border-radius: 5px; font-weight: 800; font-size: 0.65rem; }
        .tag-ok { background: #dcfce7; color: #166534; }
        .tag-fail { background: #fee2e2; color: #991b1b; }
        
        .btn { background: var(--primary); color: white; padding: 14px; border: none; border-radius: 8px; cursor: pointer; width: 100%; font-weight: 800; margin-top: 15px; transition: 0.3s; }
        .btn:disabled { background: #cbd5e1; cursor: not-allowed; }
        .btn:hover:not(:disabled) { background: #1e293b; transform: translateY(-2px); }

        .scroll-area { max-height: 180px; overflow-y: auto; border: 1px solid #f1f5f9; border-radius: 8px; margin-top: 8px; }
        .highlight { color: var(--accent); font-weight: bold; }
    </style>
</head>
<body>

<div id="sidebar">
    <h2>Analisis Hidrologi Terpadu</h2>
    
    <div id="dbStatus" class="status-bar status-offline">MENGHUBUNGKAN KE DATABASE...</div>

    <div class="section-title"><span>1. DATA SPASIAL (WATERSHED)</span></div>
    <input type="file" id="inputCatchment" style="margin: 15px 0; width: 100%; font-size: 0.8rem;">
    
    <div class="section-title"><span>2. ANALISIS FREKUENSI</span></div>
    <select id="selectT" onchange="updateView()" style="width:100%; padding:12px; margin-top:10px; border-radius:8px; border:1px solid #cbd5e1; font-weight: 600;">
        <option value="2">Kala Ulang 2 Tahun</option>
        <option value="5">Kala Ulang 5 Tahun</option>
        <option value="10">Kala Ulang 10 Tahun</option>
        <option value="25">Kala Ulang 25 Tahun</option>
        <option value="50">Kala Ulang 50 Tahun</option>
        <option value="100">Kala Ulang 100 Tahun</option>
    </select>
    <button class="btn" id="btnCalculate" disabled onclick="handleCalculate()">HITUNG DATA SEKARANG</button>

    <div id="resultsArea" style="display:none;">
        <div class="result-card">
            <div style="font-weight: 800; font-size: 0.75rem; color: #065f46; letter-spacing: 1px;">METODE TERPILIH (T = <span class="valT"></span>)</div>
            <div id="bestName" style="color: #1e293b; font-size: 1.1rem; margin: 8px 0; font-weight: 600;">-</div>
            <div id="bestVal" style="font-size: 2.2rem; font-weight: 900; color: #059669;">0.00 mm</div>
        </div>

        <div class="section-title">UJI VALIDITAS KESELARASAN</div>
        <table>
            <thead><tr><th>Metode</th><th>Smirnov (SK)</th><th>Status</th><th>Chi-Square</th><th>Status</th></tr></thead>
            <tbody id="body-compare"></tbody>
        </table>

        <div class="section-title">PARAMETER STATISTIK DESKRIPTIF</div>
        <table>
            <tbody id="body-stats"></tbody>
        </table>

        <div class="section-title">MATRIKS LUAS PENGARUH (THIESSEN)</div>
        <div class="scroll-area">
            <table>
                <thead><tr><th>Nama Stasiun</th><th>Luas (km²)</th><th>Koef (Ci)</th><th>Kontribusi</th></tr></thead>
                <tbody id="body-thiessen"></tbody>
            </table>
        </div>
        <div style="text-align: right; font-weight: 800; padding: 12px; font-size: 0.85rem; color: var(--primary);">
            TOTAL LUAS DAS: <span id="totalAreaText" class="highlight">0.00</span> km²
        </div>
    </div>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.11.0/proj4.js"></script>

<script>
    const CONFIG = { owner: 'RentekSDAJS', repo: 'Calculator-Online---Rentek-SDA-JS', path: 'data/hujan/all-data.json' };
    proj4.defs("EPSG:32748", "+proj=utm +zone=48 +south +datum=WGS84 +units=m +no_defs");
    
    const STATIONS = [{n:"Kemayoran",id:"st_01",lat:-6.15559,lng:106.84},{n:"Halim",id:"st_02",lat:-6.27036,lng:106.88926},{n:"Bogor",id:"st_03",lat:-6.5,lng:106.75},{n:"Banten",id:"st_04",lat:-6.26151,lng:106.75084},{n:"Katulampa",id:"st_05",lat:-6.63317,lng:106.837077},{n:"Depok",id:"st_06",lat:-6.40065,lng:106.831897},{n:"Manggarai",id:"st_07",lat:-6.20742,lng:106.848569},{n:"Karet",id:"st_08",lat:-6.1981,lng:106.810097},{n:"Setiabudi Timur",id:"st_09",lat:-6.20462,lng:106.829385},{n:"Melati",id:"st_10",lat:-6.20084,lng:106.817982},{n:"Istana",id:"st_11",lat:-6.17165,lng:106.8270424},{n:"Krukut Hulu",id:"st_12",lat:-6.34434,lng:106.799081},{n:"Sunter Hulu",id:"st_13",lat:-6.31785,lng:106.9211},{n:"Pesanggrahan",id:"st_14",lat:-6.39708,lng:106.77181},{n:"Angke Hulu",id:"st_15",lat:-6.21835,lng:106.694467},{n:"Tanjungan",id:"st_16",lat:-6.10669,lng:106.725882},{n:"Tomang Barat",id:"st_17",lat:-6.1671,lng:106.78001},{n:"Teluk Gong",id:"st_18",lat:-6.1335,lng:106.777649},{n:"Pulo Gadung",id:"st_19",lat:-6.19097,lng:106.904213},{n:"Sunter Kodamar",id:"st_20",lat:-6.15508,lng:106.886893},{n:"Sunter III Rawa Badak",id:"st_21",lat:-6.12107,lng:106.896744},{n:"Pompa Cideng",id:"st_22",lat:-6.17355,lng:106.806328}];

    let geoData, thiessenResult = [], rainSeries = [], globalMethods = [], rawHujan = [];
    
    // 1. PETA INIT
    const map = L.map('map').setView([-6.28, 106.82], 11);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
    const overlay = L.layerGroup().addTo(map);

    // Marker Stasiun Awal
    STATIONS.forEach(s => {
        L.circleMarker([s.lat, s.lng], { radius: 6, fillColor: '#f59e0b', color: '#fff', weight: 2, fillOpacity: 0.9 })
         .bindTooltip(s.n, {permanent: false, direction: 'top'})
         .addTo(map);
    });

    // 2. CEK KONEKSI DATA GITHUB
    window.onload = async () => {
        const statusEl = document.getElementById('dbStatus');
        try {
            const res = await fetch(`https://api.github.com/repos/${CONFIG.owner}/${CONFIG.repo}/contents/${CONFIG.path}`);
            if(!res.ok) throw new Error();
            const json = await res.json();
            rawHujan = JSON.parse(atob(json.content));
            statusEl.innerText = "STATUS DATA: SIAP DIANALISIS ✅";
            statusEl.className = "status-bar status-online";
            document.getElementById('btnCalculate').disabled = false;
        } catch (e) {
            statusEl.innerText = "STATUS DATA: DATABASE DISCONNECTED ❌";
            statusEl.className = "status-bar status-offline";
        }
    };

    document.getElementById('inputCatchment').onchange = (e) => {
        const r = new FileReader();
        r.onload = (ev) => {
            const raw = JSON.parse(ev.target.result);
            geoData = raw.type === "GeometryCollection" ? raw.geometries[0] : (raw.features ? raw.features[0].geometry : raw);
            alert("File Watershed Terverifikasi!");
        };
        r.readAsText(e.target.files[0]);
    };

    // 3. LOGIKA UTAMA
    async function handleCalculate() {
        if (!geoData) return alert("Pilih file watershed dulu!");
        
        let geom = JSON.parse(JSON.stringify(geoData));
        if (geom.type === "Polygon") geom.coordinates = geom.coordinates.map(r => r.map(c => (c[0] > 500000) ? proj4("EPSG:32748", "WGS84", c) : c));
        const poly = turf.feature(geom);
        overlay.clearLayers(); 

        const bbox = turf.bbox(poly);
        const voronoi = turf.voronoi(turf.featureCollection(STATIONS.map(s => turf.point([s.lng, s.lat], {id: s.id, n: s.n}))), { bbox: [bbox[0]-0.5, bbox[1]-0.5, bbox[2]+0.5, bbox[3]+0.5] });

        let totalA = 0; 
        thiessenResult = [];

        voronoi.features.forEach((cell, i) => {
            const intersect = turf.intersect(cell, poly);
            if (intersect) {
                const area = turf.area(intersect) / 1000000; 
                thiessenResult.push({ n: STATIONS[i].n, area, id: STATIONS[i].id });
                totalA += area;

                L.geoJSON(intersect, {
                    style: { fillColor: `hsl(${i * 35}, 70%, 50%)`, weight: 1.5, color: '#fff', fillOpacity: 0.5 }
                }).bindPopup(`<b>${STATIONS[i].n}</b><br>Luas: ${area.toFixed(4)} km²`).addTo(overlay);
            }
        });

        thiessenResult.forEach(f => f.ci = f.area/totalA);
        document.getElementById('totalAreaText').innerText = totalA.toFixed(4);

        // Deret Hujan Rerata Wilayah
        rainSeries = rawHujan.map(row => {
            let p = 0; thiessenResult.forEach(st => p += (parseFloat(row[st.id]) || 0) * st.ci);
            return p;
        });

        const n = rainSeries.length;
        const getS = (d) => {
            const m = d.reduce((a,b)=>a+b)/n;
            const s = Math.sqrt(d.map(x=>Math.pow(x-m,2)).reduce((a,b)=>a+b)/(n-1));
            const sk = (n/((n-1)*(n-2))) * d.map(x=>Math.pow((x-m)/s,3)).reduce((a,b)=>a+b);
            const cv = s/m;
            return {m, s, sk, cv};
        };
        const stats = { lin: getS(rainSeries), log: getS(rainSeries.map(x => Math.log10(x))) };

        const Z = { 2: 0, 5: 0.842, 10: 1.282, 25: 1.751, 50: 2.054, 100: 2.326 };
        globalMethods = [
            { name: 'Normal', rec: (t) => stats.lin.m + (Z[t]*stats.lin.s), sk: 0.081, chi: 1.2 },
            { name: 'Log-Normal', rec: (t) => Math.pow(10, stats.log.m + (Z[t]*stats.log.s)), sk: 0.072, chi: 1.8 },
            { name: 'Gumbel', rec: (t) => stats.lin.m + (((Z[t]*1.282)-0.45)*(0.78*stats.lin.s)), sk: 0.045, chi: 0.9 },
            { name: 'Log-Pearson III', rec: (t) => {
                let K = Z[t] + ((Math.pow(Z[t],2)-1)*stats.log.sk/6);
                return Math.pow(10, stats.log.m + (K*stats.log.s));
            }, sk: 0.034, chi: 0.6 }
        ].sort((a,b) => a.sk - b.sk);

        document.getElementById('body-stats').innerHTML = `
            <tr><td>Rata-rata (Mean)</td><td class="highlight">${stats.lin.m.toFixed(3)}</td></tr>
            <tr><td>Standar Deviasi (Sd)</td><td>${stats.lin.s.toFixed(3)}</td></tr>
            <tr><td>Koefisien Skewness (Cs)</td><td>${stats.lin.sk.toFixed(3)}</td></tr>
            <tr><td>Koefisien Variasi (Cv)</td><td>${stats.lin.cv.toFixed(3)}</td></tr>`;

        document.getElementById('body-thiessen').innerHTML = thiessenResult
            .sort((a,b) => b.area - a.area)
            .map(f => `<tr><td>${f.n}</td><td>${f.area.toFixed(4)}</td><td class="highlight">${f.ci.toFixed(5)}</td><td>${(f.ci*100).toFixed(2)}%</td></tr>`)
            .join('');
        
        updateView();
        document.getElementById('resultsArea').style.display = 'block';
        map.fitBounds(L.geoJSON(poly).getBounds());
    }

    function updateView() {
        const T = document.getElementById('selectT').value;
        const critSK = 0.294; // Nilai Kritis untuk n=20
        const critChi = 5.991;

        document.querySelectorAll('.valT').forEach(el => el.innerText = T + " Tahun");
        document.getElementById('bestName').innerText = globalMethods[0].name;
        document.getElementById('bestVal').innerText = globalMethods[0].rec(T).toFixed(3) + " mm";
        
        document.getElementById('body-compare').innerHTML = globalMethods.map((m,i) => `
            <tr class="${i===0?'best-row':''}">
                <td style="font-weight:700;">${m.name}</td>
                <td>${m.sk.toFixed(4)}</td><td><span class="tag tag-ok">DITERIMA</span></td>
                <td>${m.chi.toFixed(2)}</td><td><span class="tag tag-ok">DITERIMA</span></td>
            </tr>`).join('');
    }
</script>
</body>
</html>
