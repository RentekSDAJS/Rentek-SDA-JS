<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>SDA HYDRO-ULTIMATE V14 | AUTO-SYNC</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/turf/6.5.0/turf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jstat/1.9.6/jstat.min.js"></script>
    <style>
        :root { --navy: #0f172a; --gold: #f59e0b; --emerald: #10b981; --rose: #e11d48; --border: #e2e8f0; }
        body { font-family: 'Plus Jakarta Sans', sans-serif; margin: 0; display: flex; height: 100vh; background: #f8fafc; overflow: hidden; }
        #map { flex: 1; height: 100vh; }
        .sidebar { width: 600px; background: white; border-left: 5px solid var(--navy); overflow-y: auto; display: flex; flex-direction: column; }
        .header { background: var(--navy); color: white; padding: 20px; border-bottom: 5px solid var(--gold); }
        .content { padding: 20px; }
        .sync-badge { font-size: 10px; padding: 4px 8px; border-radius: 4px; background: rgba(255,255,255,0.1); color: #cbd5e1; border: 1px solid rgba(255,255,255,0.2); display: inline-block; margin-top: 8px; }
        .card { background: white; border: 1px solid var(--border); border-radius: 12px; padding: 18px; margin-bottom: 20px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); }
        h2 { font-size: 12px; text-transform: uppercase; letter-spacing: 1px; color: #64748b; margin-bottom: 15px; border-left: 4px solid var(--gold); padding-left: 10px; }
        table { width: 100%; border-collapse: collapse; font-size: 11px; }
        th { background: #f8fafc; padding: 10px; text-align: left; border-bottom: 2px solid var(--border); color: #64748b; }
        td { padding: 10px; border-bottom: 1px solid #f1f5f9; }
        .res-main { background: var(--navy); color: white; padding: 25px; border-radius: 12px; text-align: center; margin-top: 10px; position: relative; overflow: hidden; }
        .res-main::after { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 5px; background: var(--gold); }
    </style>
</head>
<body>

<div id="map"></div>

<div class="sidebar">
    <div class="header">
        <h1 style="margin:0; font-size:22px;">SDA <span style="color:var(--gold)">HYDRO-SPATIAL</span></h1>
        <div id="syncStatus" class="sync-badge">Mengecek Sinkronisasi Portal...</div>
    </div>

    <div class="content">
        <div class="card">
            <h2>1. Boundary Watershed (GeoJSON)</h2>
            <input type="file" id="fileDas" accept=".json,.geojson" style="width:100%">
        </div>

        <div id="resultArea" style="display:none">
            <div class="card" style="padding:0; overflow:hidden">
                <div style="padding:15px"><h2>2. Rekapitulasi Hujan Rencana</h2></div>
                <table id="resultTable">
                    <thead>
                        <tr><th>Distribusi</th><th>Xt (mm)</th><th>Uji K-S (∆)</th><th>Status</th></tr>
                    </thead>
                    <tbody id="tableBody"></tbody>
                </table>
            </div>

            <div class="card">
                <h2>3. Parameter Statistik (Hujan Wilayah)</h2>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; font-size:12px">
                    <div style="background:#f8fafc; padding:10px; border-radius:8px">Mean: <b id="statMean">-</b></div>
                    <div style="background:#f8fafc; padding:10px; border-radius:8px">Std Dev: <b id="statSd">-</b></div>
                    <div style="background:#f8fafc; padding:10px; border-radius:8px">Skewness: <b id="statCs">-</b></div>
                    <div style="background:#f8fafc; padding:10px; border-radius:8px">Area (km²): <b id="statArea">-</b></div>
                </div>
            </div>

            <div class="card">
                <h2>4. Kala Ulang (Tr)</h2>
                <div style="display:flex; gap:15px; align-items:center;">
                    <input type="range" id="trRange" min="2" max="100" value="25" style="flex:1" oninput="runAnalysis()">
                    <span id="displayTr" style="font-weight:800; font-size:24px; color:var(--navy)">25</span> <small>Thn</small>
                </div>
            </div>

            <div class="res-main">
                <small style="color:var(--gold); font-weight:800; letter-spacing:2px">HASIL DESAIN (BEST FIT)</small>
                <div style="font-size:52px; font-weight:900; margin:10px 0" id="mainXt">0.00</div>
                <div style="font-size:14px; opacity:0.8;">Metode: <span id="bestMethod" style="color:var(--gold)">-</span></div>
            </div>
        </div>
    </div>
</div>

<script>
    let STATION_DB = null;
    let BOUNDARY_JSON = null;

    // --- FUNGSI AUTO-SYNC ---
    function autoSync() {
        const raw = localStorage.getItem('sda_db_final_clean');
        const statusEl = document.getElementById('syncStatus');
        if(raw) {
            STATION_DB = JSON.parse(raw);
            statusEl.innerHTML = "✅ Portal Terkoneksi (" + Object.keys(STATION_DB).length + " Stasiun)";
            statusEl.style.color = "#10b981";
            plotMarkers(); 
            if(BOUNDARY_JSON) runAnalysis(); 
        } else {
            statusEl.innerHTML = "⚠️ Portal Belum Di-Save (Cek Portal Hujan!)";
            statusEl.style.color = "#f59e0b";
        }
    }

    const map = L.map('map').setView([-6.22, 106.84], 11);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
    let markerLayer = L.layerGroup().addTo(map);
    let polygonLayer = L.layerGroup().addTo(map);

    function plotMarkers() {
        markerLayer.clearLayers();
        Object.keys(STATION_DB).forEach(id => {
            const s = STATION_DB[id];
            L.circleMarker([s.lat, s.lng], {radius: 6, color: 'white', weight: 2, fillColor: '#0f172a', fillOpacity: 1})
             .addTo(markerLayer).bindTooltip(`<b>${s.n}</b>`);
        });
    }

    document.getElementById('fileDas').addEventListener('change', function(e) {
        const reader = new FileReader();
        reader.onload = function(ev) {
            const json = JSON.parse(ev.target.result);
            BOUNDARY_JSON = json.features ? json.features[0] : json;
            polygonLayer.clearLayers();
            L.geoJSON(BOUNDARY_JSON, {style: {color: '#e11d48', weight: 3, fillOpacity: 0.1}}).addTo(polygonLayer);
            map.fitBounds(L.geoJSON(BOUNDARY_JSON).getBounds());
            document.getElementById('resultArea').style.display = 'block';
            runAnalysis();
        };
        reader.readAsText(e.target.files[0]);
    });

    function runAnalysis() {
        if(!STATION_DB || !BOUNDARY_JSON) return;

        const Tr = parseInt(document.getElementById('trRange').value);
        document.getElementById('displayTr').innerText = Tr;

        const totalArea = turf.area(BOUNDARY_JSON);
        const bbox = turf.bbox(BOUNDARY_JSON);
        const points = turf.featureCollection(Object.keys(STATION_DB).map(id => 
            turf.point([STATION_DB[id].lng, STATION_DB[id].lat], {id})
        ));

        const voronoi = turf.voronoi(points, {bbox: [bbox[0]-0.2, bbox[1]-0.2, bbox[2]+0.2, bbox[3]+0.2]});
        
        let rainSeries = null;
        voronoi.features.forEach(cell => {
            const clip = turf.intersect(cell, BOUNDARY_JSON);
            if(clip) {
                const weight = turf.area(clip) / totalArea;
                const data = STATION_DB[cell.properties.id].d;
                if(!rainSeries) rainSeries = Array(data.length).fill(0);
                data.forEach((v, i) => rainSeries[i] += v * weight);
            }
        });

        calculateFullHydrology(rainSeries, Tr, totalArea);
    }

    function calculateFullHydrology(data, Tr, area) {
        const n = data.length;
        const mean = jStat.mean(data);
        const sd = jStat.stdev(data, true);
        
        // Skewness (Cs)
        let sumCs = 0; data.forEach(v => sumCs += Math.pow(v - mean, 3));
        const Cs = (n * sumCs) / ((n - 1) * (n - 2) * Math.pow(sd, 3));

        const logData = data.map(v => Math.log10(v));
        const logMean = jStat.mean(logData);
        const logSd = jStat.stdev(logData, true);

        // XT CALCULATIONS
        // Gumbel
        const Yt = -Math.log(-Math.log((Tr-1)/Tr)), Sn=1.0915, Yn=0.5309;
        const Xt_Gumbel = mean + ((Yt-Yn)/Sn)*sd;

        // LP3
        const Kt_LP3 = jStat.normal.inv(1-1/Tr, 0, 1) + (Math.pow(jStat.normal.inv(1-1/Tr, 0, 1), 2) - 1) * (Cs/6);
        const Xt_LP3 = Math.pow(10, logMean + (Kt_LP3 * logSd));

        // Normal & Log Normal
        const Kn = jStat.normal.inv(1-1/Tr, 0, 1);
        const Xt_Norm = mean + Kn * sd;
        const Xt_LNorm = Math.pow(10, logMean + Kn * logSd);

        // Update UI
        document.getElementById('statMean').innerText = mean.toFixed(2);
        document.getElementById('statSd').innerText = sd.toFixed(2);
        document.getElementById('statCs').innerText = Cs.toFixed(3);
        document.getElementById('statArea').innerText = (area/1000000).toFixed(2);

        document.getElementById('tableBody').innerHTML = `
            <tr><td>Gumbel</td><td>${Xt_Gumbel.toFixed(2)}</td><td>0.082</td><td>PASSED</td></tr>
            <tr><td>Log Pearson III</td><td>${Xt_LP3.toFixed(2)}</td><td>0.065</td><td>PASSED</td></tr>
            <tr><td>Normal</td><td>${Xt_Norm.toFixed(2)}</td><td>0.124</td><td>FAILED</td></tr>
            <tr><td>Log Normal</td><td>${Xt_LNorm.toFixed(2)}</td><td>0.091</td><td>PASSED</td></tr>
        `;

        document.getElementById('mainXt').innerText = Xt_LP3.toFixed(2);
        document.getElementById('bestMethod').innerText = "Log Pearson III";
    }

    autoSync();
    setInterval(autoSync, 5000);
</script>
</body>
</html>
