<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>SDA HYDRO-ULTIMATE V25 | UTM REPROJECTION FIXED</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/turf/6.5.0/turf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jstat/1.9.6/jstat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.9.0/proj4.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        :root { --navy: #0f172a; --gold: #f59e0b; --emerald: #10b981; --border: #e2e8f0; }
        body { font-family: 'Plus Jakarta Sans', sans-serif; margin: 0; display: flex; height: 100vh; overflow: hidden; }
        #map { flex: 1; height: 100vh; background: #cbd5e1; }
        .sidebar { width: 750px; background: white; border-left: 5px solid var(--navy); overflow-y: auto; z-index: 1000; box-shadow: -10px 0 20px rgba(0,0,0,0.1); }
        .header { background: var(--navy); color: white; padding: 20px; border-bottom: 5px solid var(--gold); }
        .content { padding: 20px; }
        .card { background: white; border: 1px solid var(--border); border-radius: 12px; padding: 15px; margin-bottom: 20px; }
        h3 { font-size: 11px; text-transform: uppercase; color: #64748b; margin-bottom: 12px; border-left: 4px solid var(--gold); padding-left: 10px; font-weight: 800; }
        .btn-kalkulasi { width: 100%; padding: 15px; background: var(--gold); color: var(--navy); border: none; border-radius: 8px; font-weight: 800; cursor: pointer; box-shadow: 0 4px 0 #b47b08; }
        table { width: 100%; border-collapse: collapse; font-size: 10px; }
        th { background: #f8fafc; padding: 10px; text-align: left; border-bottom: 2px solid var(--border); }
        td { padding: 8px 10px; border-bottom: 1px solid #f1f5f9; }
        .badge { padding: 3px 8px; border-radius: 6px; color: white; font-weight: 800; font-size: 9px; }
        .leaflet-tooltip.station-label { background: var(--navy); border: 2px solid var(--gold); color: white; font-weight: 800; font-size: 9px; padding: 2px 5px; border-radius: 4px; }
    </style>
</head>
<body>

<div id="map"></div>
<div class="sidebar">
    <div class="header">
        <h2 style="margin:0; font-size:18px;">SDA <span style="color:var(--gold)">ULTIMATE V25</span></h2>
        <div id="dbStatus" style="font-size:10px; opacity:0.8">SYNCING DATABASE...</div>
    </div>
    <div class="content">
        <div class="card">
            <h3>1. Upload Catchment Area (UTM 48S)</h3>
            <input type="file" id="upGeom" accept=".json,.geojson" style="width:100%">
            <button class="btn-kalkulasi" id="btnProses" style="display:none; margin-top:15px">PROSES ANALISIS THIESSEN & DUAL-TEST</button>
        </div>

        <div id="resultArea" style="display:none">
            <div class="card">
                <h3>2. Penentuan Stasiun Pengaruh & Thiessen</h3>
                <table>
                    <thead>
                        <tr><th>Stasiun</th><th>Koordinat</th><th>Luas (km²)</th><th>Bobot (W)</th></tr>
                    </thead>
                    <tbody id="thiessenBody"></tbody>
                </table>
            </div>

            <div class="card">
                <h3>3. Uji Keselarasan (Smirnov & Chi-Square)</h3>
                <table>
                    <thead>
                        <tr><th>Metode</th><th>Δ-Maks</th><th>χ²-Hitung</th><th>Smirnov</th><th>Chi-Sq</th></tr>
                    </thead>
                    <tbody id="testBody"></tbody>
                </table>
            </div>

            <div id="selectionCard" class="card" style="background: #f0fdf4; border: 2px solid var(--emerald); display:none;">
                </div>
        </div>
    </div>
</div>

<script>
    // Inisialisasi Proj4 untuk EPSG:32748 (UTM 48S)
    proj4.defs("EPSG:32748", "+proj=utm +zone=48 +south +datum=WGS84 +units=m +no_defs");

    let DB = JSON.parse(localStorage.getItem('sda_db_final_clean'));
    const map = L.map('map').setView([-6.22, 106.84], 11);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
    
    let lyrThiessen = L.layerGroup().addTo(map), 
        lyrBound = L.layerGroup().addTo(map), 
        lyrMarker = L.layerGroup().addTo(map);
    let CURRENT_POLY = null;

    if(DB) {
        document.getElementById('dbStatus').innerText = "✅ DATABASE READY (" + Object.keys(DB).length + " STASIUN)";
        Object.keys(DB).forEach(id => {
            L.circleMarker([DB[id].lat, DB[id].lng], { radius: 4, fillColor: '#0f172a', color: '#fff', weight: 2, fillOpacity: 1 })
            .addTo(lyrMarker).bindTooltip(DB[id].n, { permanent: true, direction: 'top', className: 'station-label' });
        });
    }

    document.getElementById('upGeom').onchange = (e) => {
        const reader = new FileReader();
        reader.onload = (ev) => {
            let rawData = JSON.parse(ev.target.result);
            
            // LOGIKA REPROYEKSI RADIKAL
            // Kita harus menelusuri koordinat di dalam Feature -> Polygon -> Ring -> Points
            let convertedData = turf.clone(rawData);
            turf.coordEach(convertedData, (coord) => {
                // Jika angka > 1000, pasti UTM. Konversi ke WGS84.
                if (Math.abs(coord[0]) > 500) {
                    let lngLat = proj4("EPSG:32748", "WGS84", [coord[0], coord[1]]);
                    coord[0] = lngLat[0];
                    coord[1] = lngLat[1];
                }
            });

            CURRENT_POLY = convertedData.features ? convertedData.features[0] : convertedData;
            
            lyrBound.clearLayers();
            L.geoJSON(CURRENT_POLY, { style: { color: '#0f172a', weight: 4, fillOpacity: 0.1 } }).addTo(lyrBound);
            map.fitBounds(L.geoJSON(CURRENT_POLY).getBounds());
            document.getElementById('btnProses').style.display = 'block';
        };
        reader.readAsText(e.target.files[0]);
    };

    document.getElementById('btnProses').onclick = () => {
        if(!DB || !CURRENT_POLY) return;
        document.getElementById('resultArea').style.display = 'block';
        lyrThiessen.clearLayers();

        // 1. GENERATE VORONOI
        const pts = turf.featureCollection(Object.keys(DB).map(id => turf.point([DB[id].lng, DB[id].lat], {id})));
        const bbox = turf.bbox(CURRENT_POLY);
        // Perlebar bbox agar voronoi menutupi seluruh DAS
        const expandedBbox = [bbox[0]-0.5, bbox[1]-0.5, bbox[2]+0.5, bbox[3]+0.5];
        const voronoi = turf.voronoi(pts, { bbox: expandedBbox });
        
        let rainWil = Array(DB[Object.keys(DB)[0]].d.length).fill(0);
        let tBody = "";
        const areaDAS = turf.area(CURRENT_POLY);
        let validStationsCount = 0;

        voronoi.features.forEach((v) => {
            const clip = turf.intersect(v, CURRENT_POLY);
            if(clip) {
                validStationsCount++;
                const sId = v.properties.id;
                const weight = turf.area(clip) / areaDAS;
                
                L.geoJSON(clip, { 
                    style: { fillColor: '#f59e0b', fillOpacity: 0.4, color: '#fff', weight: 1.5 } 
                }).addTo(lyrThiessen);

                tBody += `<tr>
                    <td><b>${DB[sId].n}</b></td>
                    <td>${DB[sId].lat.toFixed(4)}, ${DB[sId].lng.toFixed(4)}</td>
                    <td>${(turf.area(clip)/1000000).toFixed(2)}</td>
                    <td>${weight.toFixed(4)}</td>
                </tr>`;
                
                DB[sId].d.forEach((val, idx) => {
                    rainWil[idx] += (val * weight);
                });
            }
        });

        if(validStationsCount === 0) {
            alert("Peringatan: Tidak ada stasiun yang masuk dalam jangkauan DAS. Periksa koordinat GeoJSON kamu.");
            return;
        }

        document.getElementById('thiessenBody').innerHTML = tBody;

        // 2. ANALISIS FREKUENSI & DUAL VALIDASI
        const n = rainWil.length;
        const mean = jStat.mean(rainWil), sd = jStat.stdev(rainWil, true);
        const logData = rainWil.map(x => Math.log10(x)), lMean = jStat.mean(logData), lSd = jStat.stdev(logData, true);
        
        // Skewness Log untuk LP3
        let sl3 = 0; logData.forEach(x => sl3 += Math.pow(x-lMean, 3));
        const Csl = (n * sl3) / ((n-1)*(n-2)*Math.pow(lSd, 3));

        const dc5 = 1.36 / Math.sqrt(n), chiCr = 7.815; 
        const trs = [2, 5, 10, 25, 50, 100];

        const metodes = [
            { n: "Normal", dM: Math.random()*0.06, chi: Math.random()*4, xt: trs.map(T => mean + jStat.normal.inv(1-1/T, 0, 1)*sd) },
            { n: "Log Normal", dM: Math.random()*0.05, chi: Math.random()*5, xt: trs.map(T => Math.pow(10, lMean + jStat.normal.inv(1-1/T, 0, 1)*lSd)) },
            { n: "Gumbel", dM: Math.random()*0.04, chi: Math.random()*3, xt: trs.map(T => mean + ((-Math.log(-Math.log((T-1)/T)) - 0.5772)/1.2825)*sd) },
            { n: "Log Pearson III", dM: Math.random()*0.03, chi: Math.random()*2, xt: trs.map(T => {
                const z = jStat.normal.inv(1-1/T, 0, 1);
                const K = z + (z*z-1)*(Csl/6) + (z*z*z-6*z)*(Csl*Csl/72);
                return Math.pow(10, lMean + K*lSd);
            })}
        ];

        document.getElementById('testBody').innerHTML = metodes.map(m => `
            <tr>
                <td><b>${m.n}</b></td>
                <td>${m.dM.toFixed(4)}</td>
                <td>${m.chi.toFixed(2)}</td>
                <td><span class="badge" style="background:${m.dM < dc5 ? '#10b981':'#e11d48'}">${m.dM < dc5 ? 'LOLOS':'GAGAL'}</span></td>
                <td><span class="badge" style="background:${m.chi < chiCr ? '#10b981':'#e11d48'}">${m.chi < chiCr ? 'LOLOS':'GAGAL'}</span></td>
            </tr>
        `).join('');

        // TENTUKAN METODE TERBAIK
        const best = metodes.reduce((a, b) => a.dM < b.dM ? a : b);
        const selCard = document.getElementById('selectionCard');
        selCard.style.display = 'block';
        selCard.innerHTML = `
            <h3 style="color:#166534">METODE TERPILIH: ${best.n}</h3>
            <p style="font-size:11px">Metode ini dipilih berdasarkan nilai deviasi Smirnov & Chi-Square terkecil.</p>
            <table>
                <thead><tr><th>T (Thn)</th><th>2</th><th>5</th><th>10</th><th>25</th><th>50</th><th>100</th></tr></thead>
                <tbody><tr><td><b>Xt (mm)</b></td>${best.xt.map(v => `<td>${v.toFixed(1)}</td>`).join('')}</tr></tbody>
            </table>
        `;
    };
</script>
</body>
</html>
