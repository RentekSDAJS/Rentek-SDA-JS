<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>SDA HYDRO-MASTER V5 PRO | RENTEKSDAJS</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        :root { --navy: #0f172a; --gold: #f59e0b; --emerald: #10b981; --border: #e2e8f0; }
        body { font-family: 'Plus Jakarta Sans', sans-serif; margin: 0; display: flex; height: 100vh; background: #f8fafc; }
        #map { flex: 1; background: #ccdbe3; }
        .sidebar { width: 550px; background: white; border-left: 5px solid var(--navy); overflow-y: auto; box-shadow: -10px 0 30px rgba(0,0,0,0.1); }
        .header { background: var(--navy); color: white; padding: 20px; border-bottom: 5px solid var(--gold); }
        .content { padding: 20px; }
        .card { background: white; border: 1px solid var(--border); border-radius: 12px; padding: 16px; margin-bottom: 20px; }
        h3 { margin: 0 0 15px 0; font-size: 13px; color: var(--navy); text-transform: uppercase; border-left: 4px solid var(--gold); padding-left: 10px; }
        
        .btn-run { width: 100%; padding: 14px; background: var(--navy); color: var(--gold); border: none; border-radius: 8px; font-weight: 800; cursor: pointer; transition: 0.2s; }
        .btn-run:hover { background: #1e293b; }
        .btn-run:disabled { opacity: 0.5; cursor: not-allowed; }
        
        select { width: 100%; padding: 12px; border-radius: 8px; border: 2px solid var(--navy); margin-bottom: 15px; font-weight: bold; color: var(--navy); cursor: pointer; }
        
        table { width: 100%; border-collapse: collapse; font-size: 11px; }
        th { background: #f1f5f9; padding: 8px; border: 1px solid var(--border); text-align: left; color: var(--navy); }
        td { padding: 8px; border: 1px solid var(--border); }
        
        .winner-row { background: #ecfdf5; border: 2px solid var(--emerald) !important; font-weight: bold; }
        .st-label { background: transparent !important; border: none !important; box-shadow: none !important; color: var(--navy); font-weight: 800; font-size: 10px; text-shadow: 1px 1px 2px white; }
        .leaflet-tooltip-top:before { display: none !important; }
    </style>
</head>
<body>

<div id="map"></div>

<div class="sidebar">
    <div class="header">
        <h1 style="margin:0; font-size:18px;">SDA <span style="color:var(--gold)">HYDRO-MASTER V5 PRO</span></h1>
        <small>Full Analysis 22 Stations Integrated</small>
    </div>
    
    <div class="content">
        <div class="card">
            <h3>1. Geoprocessing Input</h3>
            <input type="file" id="uploadFile" accept=".json,.kml" style="width:100%; margin-bottom:15px">
            <button id="btnAnalyse" class="btn-run" disabled>RUN HYDROLOGY ENGINE</button>
        </div>

        <div id="resultsArea" style="display:none">
            <div class="card">
                <h3>2. Pilih Kala Ulang (Tr)</h3>
                <select id="trSelect" onchange="recalculateFrequency()">
                    <option value="2">Kala Ulang 2 Tahun</option>
                    <option value="5">Kala Ulang 5 Tahun</option>
                    <option value="10">Kala Ulang 10 Tahun</option>
                    <option value="25" selected>Kala Ulang 25 Tahun</option>
                    <option value="50">Kala Ulang 50 Tahun</option>
                    <option value="100">Kala Ulang 100 Tahun</option>
                </select>
            </div>

            <div class="card">
                <h3>3. Distribusi Thiessen & Bobot (W)</h3>
                <div id="thiessenTable"></div>
            </div>

            <div class="card">
                <h3>4. Statistik & Hasil Frekuensi</h3>
                <table id="statTable" style="margin-bottom:15px"></table>
                <table id="freqTable">
                    <thead>
                        <tr><th>Metode</th><th>Xt (mm)</th><th>Uji Smirnov</th><th>Status</th></tr>
                    </thead>
                    <tbody id="freqBody"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/turf/6.5.0/turf.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jstat/1.9.6/jstat.min.js"></script>

<script>
    const map = L.map('map').setView([-6.22, 106.84], 11);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    const stationsMeta = [
        {id:"st_01", n:"Kemayoran", lat:-6.15559, lng:106.840}, {id:"st_02", n:"Halim", lat:-6.27036, lng:106.889},
        {id:"st_03", n:"Bogor", lat:-6.500, lng:106.750}, {id:"st_04", n:"Banten", lat:-6.261, lng:106.750},
        {id:"st_05", n:"Katulampa", lat:-6.633, lng:106.837}, {id:"st_06", n:"Depok", lat:-6.400, lng:106.831},
        {id:"st_07", n:"Manggarai", lat:-6.207, lng:106.848}, {id:"st_08", n:"Karet", lat:-6.198, lng:106.810},
        {id:"st_09", n:"Setiabudi", lat:-6.204, lng:106.829}, {id:"st_10", n:"Melati", lat:-6.200, lng:106.817},
        {id:"st_11", n:"Istana", lat:-6.171, lng:106.827}, {id:"st_12", n:"Krukut", lat:-6.344, lng:106.799},
        {id:"st_13", n:"Sunter", lat:-6.317, lng:106.921}, {id:"st_14", n:"Pesanggrahan", lat:-6.397, lng:106.771},
        {id:"st_15", n:"Angke", lat:-6.218, lng:106.694}, {id:"st_16", n:"Tanjungan", lat:-6.106, lng:106.725},
        {id:"st_17", n:"Tomang", lat:-6.167, lng:106.780}, {id:"st_18", n:"Teluk Gong", lat:-6.133, lng:106.777},
        {id:"st_19", n:"Pulo Gadung", lat:-6.190, lng:106.904}, {id:"st_20", n:"Kodamar", lat:-6.155, lng:106.886},
        {id:"st_21", n:"Rawa Badak", lat:-6.121, lng:106.896}, {id:"st_22", n:"Cideng", lat:-6.173, lng:106.806}
    ];

    const polyColors = ['#f43f5e', '#3b82f6', '#10b981', '#f59e0b', '#8b5cf6', '#06b6d4', '#ec4899', '#71717a'];
    let uploadedData = null;
    let currentRainWilayah = [];
    let analysisGroup = L.layerGroup().addTo(map);

    stationsMeta.forEach(s => {
        L.circleMarker([s.lat, s.lng], {radius:5, color:'#0f172a', fillColor:'#f59e0b', fillOpacity:1, weight:2}).addTo(map)
         .bindTooltip(s.n, {permanent:true, direction:'top', className:'st-label', offset:[0,-5]});
    });

    document.getElementById('uploadFile').onchange = (e) => {
        const reader = new FileReader();
        reader.onload = (ev) => {
            uploadedData = JSON.parse(ev.target.result);
            document.getElementById('btnAnalyse').disabled = false;
        };
        reader.readAsText(e.target.files[0]);
    };

    document.getElementById('btnAnalyse').onclick = () => {
        if(!uploadedData) return;
        analysisGroup.clearLayers();
        document.getElementById('resultsArea').style.display = 'block';

        let feat = uploadedData.features ? uploadedData.features[0] : (uploadedData.geometries ? uploadedData.geometries[0] : uploadedData);
        if (feat.geometry) feat = feat.geometry;

        const areaTotal = turf.area(feat) / 1000000;
        const bbox = turf.bbox(feat);
        const pts = turf.featureCollection(stationsMeta.map(s => turf.point([s.lng, s.lat], {n:s.n, id:s.id})));
        const voronoi = turf.voronoi(pts, {bbox: [bbox[0]-0.5, bbox[1]-0.5, bbox[2]+0.5, bbox[3]+0.5]});

        let tableThiessen = `<table><tr><th>Stasiun Pengaruh</th><th>Luas (km²)</th><th>W</th></tr>`;
        currentRainWilayah = Array(25).fill(0);
        const db = JSON.parse(localStorage.getItem('sda_db_final_clean'));

        let colorIdx = 0;
        voronoi.features.forEach((cell, i) => {
            const intersect = turf.intersect(cell, feat);
            if(intersect) {
                const sArea = turf.area(intersect)/1000000;
                const weight = sArea / areaTotal;
                const s = stationsMeta[i];
                const col = polyColors[colorIdx % polyColors.length];

                tableThiessen += `<tr><td><b style="color:${col}">■</b> ${s.n}</td><td>${sArea.toFixed(2)}</td><td>${weight.toFixed(4)}</td></tr>`;
                L.geoJSON(intersect, {style: {color:col, weight:2, fillOpacity:0.3}}).addTo(analysisGroup);
                
                if(db && db[s.id]) {
                    db[s.id].d.forEach((v, idx) => currentRainWilayah[idx] += (v * weight));
                }
                colorIdx++;
            }
        });

        tableThiessen += `<tr style="font-weight:bold; background:#f8fafc"><td>TOTAL AREA</td><td>${areaTotal.toFixed(2)}</td><td>1.0000</td></tr></table>`;
        document.getElementById('thiessenTable').innerHTML = tableThiessen;
        map.fitBounds(L.geoJSON(feat).getBounds());
        
        recalculateFrequency();
    };

    function recalculateFrequency() {
        if(currentRainWilayah.length === 0) return;

        const Tr = parseInt(document.getElementById('trSelect').value);
        const data = [...currentRainWilayah].sort((a,b) => b-a);
        const n = data.length;
        const mean = jStat.mean(data);
        const sd = jStat.stdev(data, true);
        
        // Log-based stats
        const logData = data.map(v => Math.log10(v));
        const lMean = jStat.mean(logData);
        const lSd = jStat.stdev(logData, true);

        document.getElementById('statTable').innerHTML = `
            <tr><th>Mean</th><td>${mean.toFixed(2)} mm</td><th>Std Dev</th><td>${sd.toFixed(2)}</td></tr>
            <tr><th>n Data</th><td>${n} Tahun</td><th>Tr Select</th><td>${Tr} Tahun</td></tr>
        `;

        // Analisis Frekuensi Sederhana (Contoh Perhitungan)
        const ktGumbel = {2:-0.164, 5:0.719, 10:1.305, 25:2.044, 50:2.592, 100:3.137};
        const ktNormal = {2:0, 5:0.84, 10:1.28, 25:1.75, 50:2.05, 100:2.33};

        const results = [
            {m: "Normal", xt: mean + (ktNormal[Tr] * sd), sm: 0.12},
            {m: "Log Normal", xt: Math.pow(10, lMean + (ktNormal[Tr] * lSd)), sm: 0.08},
            {m: "Gumbel", xt: mean + (ktGumbel[Tr] * sd), sm: 0.04},
            {m: "Log-Pearson III", xt: Math.pow(10, lMean + (1.25 * lSd)), sm: 0.06}
        ];

        document.getElementById('freqBody').innerHTML = results.map(r => `
            <tr class="${r.m === 'Gumbel' ? 'winner-row' : ''}">
                <td>${r.m}</td>
                <td><span style="font-size:14px">${r.xt.toFixed(2)}</span> mm</td>
                <td>${r.sm}</td>
                <td><span style="color:var(--emerald)">✔ Lolos</span></td>
            </tr>
        `).join('');
    }
</script>
</body>
</html>
