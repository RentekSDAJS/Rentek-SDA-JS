<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>SDA INTERNAL | PLANNING SECTION</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root { --navy: #0f172a; --gold: #f59e0b; --bg: #f8fafc; --white: #ffffff; --border: #e2e8f0; --danger: #ef4444; }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: var(--bg); margin: 0; color: #1e293b; }
        
        /* LOGIN GATE - NO HINT */
        #loginGate { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--navy); display: flex; justify-content: center; align-items: center; z-index: 9999; }
        .login-card { background: white; padding: 40px; border-radius: 16px; width: 320px; text-align: center; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5); }
        
        /* NAVBAR */
        .navbar { background: var(--navy); padding: 15px 40px; border-bottom: 4px solid var(--gold); display: flex; justify-content: space-between; align-items: center; color: white; }
        .container { max-width: 1200px; margin: 30px auto; padding: 0 20px; }
        
        /* CARD & STATS */
        .card { background: white; border-radius: 12px; border: 1px solid var(--border); padding: 20px; margin-bottom: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-top: 15px; }
        .stat-item { background: #f1f5f9; padding: 12px; border-radius: 8px; border-left: 4px solid var(--navy); }
        .stat-label { font-size: 10px; font-weight: 800; color: #64748b; text-transform: uppercase; }
        .stat-val { font-size: 16px; font-weight: 800; color: var(--navy); display: block; }

        /* TABLE */
        table { width: 100%; border-collapse: collapse; background: white; }
        th { background: #f8fafc; padding: 15px; text-align: left; font-size: 11px; color: #64748b; border-bottom: 2px solid var(--border); }
        td { padding: 12px 15px; border-bottom: 1px solid var(--border); font-size: 14px; }
        .input-edit { width: 110px; padding: 8px; border: 1px solid var(--border); border-radius: 6px; font-weight: 700; font-family: inherit; }

        /* BUTTONS */
        .btn { padding: 10px 18px; border-radius: 8px; border: none; font-weight: 700; cursor: pointer; transition: 0.2s; font-family: inherit; }
        .btn-navy { background: var(--navy); color: white; }
        .btn-save { background: #16a34a; color: white; font-size: 11px; }
        .btn-del { background: transparent; color: var(--danger); border: 1px solid var(--danger); font-size: 10px; padding: 5px 10px; }
        .btn-del:hover { background: var(--danger); color: white; }
        .btn-add { background: var(--white); color: var(--navy); border: 2px dashed var(--navy); width: 100%; margin: 15px 0; }
        .btn-download { background: #3b82f6; color: white; }

        .batch-box { background: #fffbeb; border: 1px solid #fef3c7; padding: 15px; border-radius: 8px; margin-bottom: 15px; }
    </style>
</head>
<body>

<div id="loginGate">
    <div class="login-card">
        <h2 style="margin:0 0 20px 0;">INTERNAL LOGIN</h2>
        <input type="password" id="tokenIn" placeholder="Security Token" style="text-align:center" onkeypress="if(event.key==='Enter') auth()">
        <button class="btn btn-navy" style="width:100%" onclick="auth()">MASUK</button>
    </div>
</div>

<div id="app" style="display:none">
    <div class="navbar">
        <div style="font-weight: 800; font-size: 18px;">SDA <span style="color:var(--gold)">PLANNING PORTAL</span></div>
        <div style="display:flex; gap:10px">
            <button class="btn btn-download" onclick="downloadData()">Download CSV</button>
            <button class="btn" style="background:var(--gold)" onclick="logout()">Logout</button>
        </div>
    </div>

    <div class="container">
        <div class="card">
            <label style="font-weight:800; font-size:12px">PILIH DATABASE STASIUN:</label>
            <select id="stSelect" onchange="loadSt()" style="width:100%; padding:12px; margin-top:10px; border-radius:8px; border:1px solid var(--border); font-weight:600">
                <option value="">-- Silakan Pilih --</option>
            </select>
            
            <div id="stats" class="stats-grid" style="display:none">
                <div class="stat-item"><span class="stat-label">Koordinat</span><span id="cVal" class="stat-val">-</span></div>
                <div class="stat-item"><span class="stat-label">Rerata Series</span><span id="aVal" class="stat-val">-</span></div>
                <div class="stat-item"><span class="stat-label">Maksimum</span><span id="mVal" class="stat-val">-</span></div>
                <div class="stat-item"><span class="stat-label">Jumlah Data</span><span id="nVal" class="stat-val">-</span></div>
            </div>
        </div>

        <div id="mainContent" style="display:none">
            <div class="batch-box">
                <label style="font-size:11px; font-weight:800; color:#92400e">BATCH UPDATE (Copas dari Excel Vertikal di sini):</label>
                <div style="display:flex; gap:10px; margin-top:8px">
                    <textarea id="batchInput" placeholder="Tempel angka-angka secara vertikal di sini..." style="flex:1; height:40px; padding:8px; border-radius:6px; border:1px solid #fcd34d"></textarea>
                    <button class="btn btn-navy" onclick="applyBatch()">Terapkan ke Tabel</button>
                </div>
            </div>

            <div class="card" style="padding:0; overflow:hidden">
                <table>
                    <thead>
                        <tr>
                            <th>TAHUN</th>
                            <th>CURAH HUJAN (mm)</th>
                            <th>STATUS</th>
                            <th style="text-align:right">AKSI</th>
                        </tr>
                    </thead>
                    <tbody id="tb"></tbody>
                </table>
            </div>

            <button class="btn btn-add" onclick="tambahTahun()">+ TAMBAH BARIS TAHUN BERIKUTNYA</button>
        </div>
    </div>
</div>

<script>
    // Database Tetap (22 Stasiun)
    const rawDB = {
        "st_01": { n: "Kemayoran", lat: -6.15559, lng: 106.840, d: [94.8, 82.2, 168.5, 199.7, 129.3, 124.1, 72.0, 234.7, 192.7, 122.5, 93.0, 119.2, 105.2, 193.4, 147.9, 277.5, 124.5, 179.7, 104.6, 90.5, 277.5, 94.1, 204.0, 79.5, 140.9] },
        "st_22": { n: "Pompa Cideng", lat: -6.17320, lng: 106.806, d: [89.5, 85.6, 152.4, 145.2, 118.4, 103.9, 108.4, 204.5, 118.4, 115.4, 103.9, 142.0, 103.9, 162.4, 145.2, 165.4, 110.4, 103.9, 118.4, 115.4, 212.4, 103.9, 132.4, 108.4, 140.0] },
        // ... (sisanya sama)
    };

    let activeData = JSON.parse(localStorage.getItem('sda_internal_v3')) || rawDB;

    function auth() {
        if(document.getElementById('tokenIn').value === "RENTEKSDAJS") {
            sessionStorage.setItem('auth', 'true');
            document.getElementById('loginGate').style.display = 'none';
            document.getElementById('app').style.display = 'block';
            initSel();
        } else { alert("Token Salah!"); }
    }

    window.onload = () => {
        if(sessionStorage.getItem('auth') === 'true') {
            document.getElementById('loginGate').style.display = 'none';
            document.getElementById('app').style.display = 'block';
            initSel();
        }
    }

    function initSel() {
        const s = document.getElementById('stSelect');
        s.innerHTML = '<option value="">-- Pilih Stasiun --</option>';
        Object.keys(activeData).forEach(k => {
            s.innerHTML += `<option value="${k}">${activeData[k].n}</option>`;
        });
    }

    function loadSt() {
        const id = document.getElementById('stSelect').value;
        if(!id) return;
        document.getElementById('stats').style.display = 'grid';
        document.getElementById('mainContent').style.display = 'block';
        renderTb();
    }

    function renderTb() {
        const id = document.getElementById('stSelect').value;
        const b = document.getElementById('tb');
        b.innerHTML = "";
        activeData[id].d.forEach((v, i) => {
            b.innerHTML += `<tr>
                <td><strong>${2000+i}</strong></td>
                <td><input type="number" step="0.1" class="input-edit" id="v-${i}" value="${v}"></td>
                <td><span style="font-size:10px; color:#16a34a; font-weight:800">DATA VALID</span></td>
                <td style="text-align:right">
                    <button class="btn btn-save" onclick="saveOne('${id}', ${i})">Simpan</button>
                    <button class="btn btn-del" onclick="hapusTahun('${id}', ${i})">Hapus</button>
                </td>
            </tr>`;
        });
        updateStats(id);
    }

    function saveOne(id, i) {
        const val = document.getElementById(`v-${i}`).value;
        activeData[id].d[i] = parseFloat(val);
        sync();
        alert("Tersimpan!");
    }

    function hapusTahun(id, i) {
        if(confirm(`Hapus data tahun ${2000+i}? Tindakan ini tidak bisa dibatalkan.`)) {
            activeData[id].d.splice(i, 1);
            sync();
            renderTb();
        }
    }

    function tambahTahun() {
        const id = document.getElementById('stSelect').value;
        activeData[id].d.push(0);
        sync();
        renderTb();
        window.scrollTo(0, document.body.scrollHeight);
    }

    function applyBatch() {
        const id = document.getElementById('stSelect').value;
        const input = document.getElementById('batchInput').value;
        // Memecah input berdasarkan baris baru, spasi, atau koma
        const values = input.trim().split(/[\n\s,]+/).map(v => parseFloat(v));
        
        if(values.length > 0) {
            if(confirm(`Ganti ${values.length} baris data awal dengan data baru?`)) {
                values.forEach((val, idx) => {
                    if(!isNaN(val) && activeData[id].d[idx] !== undefined) {
                        activeData[id].d[idx] = val;
                    }
                });
                sync();
                renderTb();
                document.getElementById('batchInput').value = "";
            }
        }
    }

    function updateStats(id) {
        const d = activeData[id].d;
        document.getElementById('cVal').innerText = activeData[id].lat + ", " + activeData[id].lng;
        document.getElementById('aVal').innerText = (d.reduce((a,b)=>a+b,0)/d.length).toFixed(1) + " mm";
        document.getElementById('mVal').innerText = Math.max(...d).toFixed(1) + " mm";
        document.getElementById('nVal').innerText = d.length + " Tahun";
    }

    function sync() { localStorage.setItem('sda_internal_v3', JSON.stringify(activeData)); }

    function downloadData() {
        const id = document.getElementById('stSelect').value;
        if(!id) return;
        let csv = "Tahun,Curah Hujan (mm)\n";
        activeData[id].d.forEach((v, i) => { csv += `${2000+i},${v}\n`; });
        const blob = new Blob([csv], { type: 'text/csv' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `Rekap_${activeData[id].n}.csv`;
        a.click();
    }

    function logout() { sessionStorage.clear(); location.reload(); }
</script>
</body>
</html>
