<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>SDA Planning Section | Internal Rainfall Portal</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --navy: #0f172a; --gold: #f59e0b; --bg: #f1f5f9;
            --white: #ffffff; --border: #e2e8f0; --text: #1e293b; --danger: #ef4444;
        }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: var(--bg); color: var(--text); margin: 0; }
        
        /* Header & Security Bar */
        .navbar { background: var(--navy); padding: 15px 35px; border-bottom: 4px solid var(--gold); display: flex; justify-content: space-between; align-items: center; color: white; }
        .token-bar { background: #1e293b; padding: 10px 35px; display: flex; gap: 10px; align-items: center; border-bottom: 1px solid #334155; }
        .token-input { background: #0f172a; border: 1px solid #334155; color: #f59e0b; padding: 5px 12px; border-radius: 4px; font-size: 12px; width: 250px; }
        
        .container { max-width: 1100px; margin: 30px auto; padding: 0 20px; }
        .card { background: var(--white); border-radius: 12px; border: 1px solid var(--border); padding: 25px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); margin-bottom: 25px; }
        
        .stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-top: 15px; }
        .stat-item { background: #f8fafc; padding: 15px; border-radius: 8px; border-left: 4px solid var(--navy); }
        .stat-label { font-size: 10px; font-weight: 800; color: #64748b; text-transform: uppercase; }
        .stat-value { font-size: 20px; font-weight: 800; color: var(--navy); display: block; }

        /* Table & Inputs */
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th { background: #f8fafc; color: var(--navy); text-align: left; padding: 15px; font-size: 11px; border-bottom: 2px solid var(--border); }
        td { padding: 12px 15px; border-bottom: 1px solid var(--border); font-size: 14px; }
        .input-edit { border: 1px solid var(--border); padding: 8px; border-radius: 6px; font-weight: 700; width: 100px; }

        /* Buttons */
        .btn { border: none; border-radius: 6px; font-weight: 700; cursor: pointer; transition: 0.3s; font-family: inherit; }
        .btn-add { background: var(--navy); color: var(--gold); padding: 10px 20px; border: 1px solid var(--gold); margin-bottom: 15px; }
        .btn-add:hover { background: var(--gold); color: var(--navy); }
        .btn-save { background: #22c55e; color: white; padding: 6px 12px; font-size: 11px; }
        .btn-excel { background: var(--navy); color: white; padding: 12px 25px; border: 1px solid var(--gold); }
        
        .badge-planning { background: #dcfce7; color: #166534; padding: 4px 8px; border-radius: 4px; font-size: 10px; font-weight: 800; }
    </style>
</head>
<body>

<div class="navbar">
    <div style="font-weight: 800; font-size: 18px;">SDA PLANNING <span style="color:var(--gold)">INTERNAL PORTAL</span></div>
    <div class="badge-planning">SEKSI PERENCANAAN ONLY</div>
</div>

<div class="token-bar">
    <label style="color: #94a3b8; font-size: 11px; font-weight: 700;">GITHUB ACCESS TOKEN :</label>
    <input type="password" id="ghToken" class="token-input" placeholder="Masukkan Token Internal untuk Mengedit...">
</div>

<div class="container">
    <div class="card">
        <div style="font-weight: 800; margin-bottom: 15px; font-size: 14px;">KONTROL DATA STASIUN</div>
        <select id="stSelect" onchange="loadData()" style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid var(--border);">
            <option value="">-- Pilih Stasiun Pengamatan --</option>
        </select>
        
        <div id="meta" class="stats-grid" style="display:none">
            <div class="stat-item"><span class="stat-label">KOORDINAT</span><span id="coord" class="stat-value">-</span></div>
            <div class="stat-item"><span class="stat-label">RERATA SERIES</span><span id="avg" class="stat-value">-</span></div>
            <div class="stat-item"><span class="stat-label">MAKSIMUM</span><span id="max" class="stat-value">-</span></div>
        </div>
    </div>

    <div id="content" style="display:none">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <button class="btn btn-add" onclick="addNewYear()">+ TAMBAH DATA TAHUN BERIKUTNYA</button>
            <button class="btn btn-excel" onclick="exportExcel()">EXPORT EXCEL</button>
        </div>

        <div class="card" style="padding: 0; overflow: hidden;">
            <table>
                <thead>
                    <tr>
                        <th>TAHUN</th>
                        <th>CURAH HUJAN (mm)</th>
                        <th>OTORITAS</th>
                        <th>AKSI</th>
                    </tr>
                </thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>
    </div>
</div>

<script>
    // Database utama (Disimpan di LocalStorage sebagai simulasi Gist/Internal Database)
    let activeDB = {};
    const defaultData = {
        "st_01": { n: "Kemayoran", lat: -6.15559, lng: 106.840, d: [94.8, 82.2, 168.5, 199.7, 129.3, 124.1, 72.0, 234.7, 192.7, 122.5, 93.0, 119.2, 105.2, 193.4, 147.9, 277.5, 124.5, 179.7, 104.6, 90.5, 277.5, 94.1, 204.0, 79.5, 140.9] },
        "st_22": { n: "Pompa Cideng", lat: -6.17320, lng: 106.806, d: [89.5, 85.6, 152.4, 145.2, 118.4, 103.9, 108.4, 204.5, 118.4, 115.4, 103.9, 142.0, 103.9, 162.4, 145.2, 165.4, 110.4, 103.9, 118.4, 115.4, 212.4, 103.9, 132.4, 108.4, 140.0] }
        // ... (data stasiun lainnya bisa ditambah di sini)
    };

    function init() {
        const saved = localStorage.getItem('sda_internal_db');
        activeDB = saved ? JSON.parse(saved) : defaultData;
        
        const sel = document.getElementById('stSelect');
        Object.keys(activeDB).forEach(id => {
            sel.innerHTML += `<option value="${id}">${activeDB[id].n}</option>`;
        });
    }

    function loadData() {
        const id = document.getElementById('stSelect').value;
        if(!id) return;
        document.getElementById('meta').style.display = 'grid';
        document.getElementById('content').style.display = 'block';
        renderTable();
    }

    function renderTable() {
        const id = document.getElementById('stSelect').value;
        const body = document.getElementById('tableBody');
        const data = activeDB[id].d;
        
        document.getElementById('coord').innerText = `${activeDB[id].lat}, ${activeDB[id].lng}`;
        
        let htm = "";
        data.forEach((val, i) => {
            htm += `<tr>
                <td><strong>${2000 + i}</strong></td>
                <td><input type="number" step="0.1" class="input-edit" id="input-${i}" value="${val}"></td>
                <td><span class="badge-planning">PLANNING SEC</span></td>
                <td><button class="btn btn-save" onclick="saveData('${id}', ${i})">PUSH DATA</button></td>
            </tr>`;
        });
        body.innerHTML = htm;
        updateStats(data);
    }

    function addNewYear() {
        const id = document.getElementById('stSelect').value;
        const currentData = activeDB[id].d;
        const nextYear = 2000 + currentData.length;
        
        if(confirm(`Tambah kolom input untuk tahun ${nextYear}?`)) {
            activeDB[id].d.push(0); // Tambah data kosong
            renderTable();
            window.scrollTo(0, document.body.scrollHeight);
        }
    }

    function saveData(stId, idx) {
        const token = document.getElementById('ghToken').value;
        
        // Proteksi Token (Simulasi Internal)
        if(token !== "SDA2024") { // <--- Ganti "SDA2024" dengan password/token internal kalian
            alert("AKSES DITOLAK! Token GitHub/Internal Salah atau Belum Diisi.");
            return;
        }

        const newVal = document.getElementById(`input-${idx}`).value;
        activeDB[stId].d[idx] = parseFloat(newVal);
        
        // Simpan Permanen
        localStorage.setItem('sda_internal_db', JSON.stringify(activeDB));
        renderTable();
        alert(`SUKSES: Data tahun ${2000+idx} telah dipush ke database Planning.`);
    }

    function updateStats(data) {
        const max = Math.max(...data);
        const avg = (data.reduce((a, b) => a + b, 0) / data.length).toFixed(1);
        document.getElementById('max').innerText = max.toFixed(1) + " mm";
        document.getElementById('avg').innerText = avg + " mm";
    }

    function exportExcel() {
        const id = document.getElementById('stSelect').value;
        const name = activeDB[id].n;
        let tab = `<table border="1"><tr style="background:#0f172a;color:#f59e0b"><th>Tahun</th><th>Curah Hujan (mm)</th></tr>`;
        activeDB[id].d.forEach((v, i) => { tab += `<tr><td>${2000+i}</td><td>${v}</td></tr>`; });
        tab += `</table>`;
        const blob = new Blob([tab], { type: 'application/vnd.ms-excel' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob); a.download = `Internal_Planning_${name}.xls`; a.click();
    }

    init();
</script>
</body>
</html>
