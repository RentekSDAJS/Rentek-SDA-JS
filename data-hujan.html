<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SDA Data Hub - Station Information System</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        :root { --navy: #0f172a; --gold: #d4af37; --teal: #0d9488; --red: #ef4444; --slate: #64748b; }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: #f1f5f9; margin: 0; padding: 0; color: #1e293b; }

        /* Header Style */
        #top-header {
            position: fixed; top: 0; left: 0; right: 0; height: 80px; 
            background: var(--navy); color: white; display: flex; 
            align-items: center; justify-content: space-between; 
            padding: 0 25px; border-bottom: 5px solid var(--gold); z-index: 2000;
        }
        .main-title { font-weight: 900; font-size: 1.2rem; text-transform: uppercase; letter-spacing: 1px; }
        .btn-logout { background: transparent; border: 1px solid var(--red); color: var(--red); padding: 8px 15px; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 0.8rem; }

        /* Layout */
        .container { max-width: 1200px; margin: 0 auto; padding: 110px 20px 40px 20px; display: none; }
        
        /* Master Selector */
        .station-selector { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 20px; display: flex; align-items: center; gap: 15px; }
        .station-selector select { flex: 1; padding: 15px; border: 2px solid var(--navy); border-radius: 10px; font-weight: 700; font-size: 1.1rem; color: var(--navy); }

        /* Info Grid */
        .info-grid { display: grid; grid-template-columns: 1fr 2fr; gap: 20px; }
        
        .card { background: white; padding: 25px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); border: 1px solid #e2e8f0; }
        .card-title { font-size: 0.8rem; font-weight: 900; color: var(--slate); text-transform: uppercase; margin-bottom: 15px; border-left: 4px solid var(--gold); padding-left: 10px; }

        /* Statistics Boxes */
        .stat-box { background: #f8fafc; padding: 15px; border-radius: 12px; margin-bottom: 10px; border-left: 4px solid var(--navy); }
        .stat-label { font-size: 0.65rem; font-weight: 800; color: var(--slate); text-transform: uppercase; }
        .stat-value { font-size: 1.2rem; font-weight: 900; color: var(--navy); display: block; }

        /* Form Controls */
        label { font-size: 0.7rem; font-weight: 800; color: var(--navy); text-transform: uppercase; margin-bottom: 5px; display: block; }
        input { padding: 12px; border: 1px solid #cbd5e1; border-radius: 8px; width: 100%; box-sizing: border-box; margin-bottom: 10px; font-family: inherit; font-weight: 600; }
        
        .btn-update { background: var(--navy); color: var(--gold); padding: 12px; width: 100%; border-radius: 8px; font-weight: 800; border: none; cursor: pointer; margin-top: 5px; }
        .btn-add { background: var(--teal); color: white; padding: 12px; width: 100%; border-radius: 8px; font-weight: 800; border: none; cursor: pointer; }

        /* Table */
        .table-container { max-height: 400px; overflow-y: auto; }
        table { width: 100%; border-collapse: collapse; }
        th { background: #f8fafc; padding: 12px; text-align: left; font-size: 0.7rem; color: var(--slate); border-bottom: 2px solid #e2e8f0; position: sticky; top: 0; }
        td { padding: 12px; border-bottom: 1px solid #f1f5f9; font-size: 0.9rem; font-weight: 600; }
        .del-text { color: var(--red); cursor: pointer; font-size: 0.75rem; font-weight: 800; }

        /* Auth */
        #authOverlay { position: fixed; inset: 0; background: var(--navy); display: flex; align-items: center; justify-content: center; z-index: 9999; }
        #loading { display: none; position: fixed; inset: 0; background: rgba(255,255,255,0.9); z-index: 10000; align-items: center; justify-content: center; flex-direction: column; }
    </style>
</head>
<body>

<div id="top-header">
    <div class="main-title">SDA Station Manager</div>
    <button class="btn-logout" onclick="logout()">LOGOUT</button>
</div>

<div id="loading"><h3>Sinkronisasi Database... ‚è≥</h3></div>

<div id="authOverlay">
    <div style="background:white; padding:40px; border-radius:24px; text-align:center; width:320px;">
        <h2 style="color:var(--navy); margin-top:0;">Access Control</h2>
        <input type="password" id="passCode" placeholder="Password Admin" style="text-align:center;">
        <input type="password" id="gitToken" placeholder="GitHub Token" style="text-align:center;">
        <button onclick="login()" style="background:var(--navy); color:var(--gold); padding:15px; width:100%; border-radius:10px; font-weight:bold; cursor:pointer; border:none; margin-top:10px;">MASUK SISTEM</button>
    </div>
</div>

<div class="container" id="mainApp">
    <div class="station-selector">
        <span style="font-weight: 900; color: var(--navy); text-transform: uppercase; font-size: 0.8rem;">Pilih Stasiun:</span>
        <select id="masterStation" onchange="loadStationData()"></select>
    </div>

    <div class="info-grid">
        <div class="left-col">
            <div class="card" style="margin-bottom:20px;">
                <div class="card-title">Informasi & Koordinat</div>
                <label>Latitude (Y)</label>
                <input type="number" step="0.000001" id="stLat">
                <label>Longitude (X)</label>
                <input type="number" step="0.000001" id="stLng">
                <button class="btn-update" onclick="updateStationMeta()">UPDATE KOORDINAT</button>
            </div>

            <div class="card">
                <div class="card-title">Rekapitulasi Data</div>
                <div class="stat-box">
                    <span class="stat-label">Rerata Hujan (Series)</span>
                    <span class="stat-value" id="statAvg">0 mm</span>
                </div>
                <div class="stat-box">
                    <span class="stat-label">Hujan Maksimum</span>
                    <span class="stat-value" id="statMax" style="color: var(--red);">0 mm</span>
                </div>
                <div class="stat-box">
                    <span class="stat-label">Ketersediaan Data</span>
                    <span class="stat-value" id="statCount">0 Tahun</span>
                </div>
            </div>
        </div>

        <div class="right-col">
            <div class="card" style="height: 100%;">
                <div class="card-title">Data Series Hujan Tahunan</div>
                
                <div style="display:grid; grid-template-columns: 1fr 1fr auto; gap:10px; margin-bottom:20px; background:#f8fafc; padding:15px; border-radius:12px;">
                    <div><label>Tahun</label><input type="number" id="newYear" placeholder="2024"></div>
                    <div><label>Nilai (mm)</label><input type="number" step="0.1" id="newVal" placeholder="0.0"></div>
                    <div style="display:flex; align-items:flex-end;"><button class="btn-add" onclick="addNewData()">TAMBAH</button></div>
                </div>

                <div class="table-container">
                    <table>
                        <thead>
                            <tr><th>TAHUN</th><th>CURAH HUJAN (mm)</th><th style="text-align:right;">AKSI</th></tr>
                        </thead>
                        <tbody id="seriesTable"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const CONFIG = { owner: 'RentekSDAJS', repo: 'Calculator-Online---Rentek-SDA-JS', path: 'data/hujan/all-data.json' };
    let allData = [], sha = '';
    
    // Daftar Nama Stasiun (Tanpa Kode)
    const STATIONS_NAMES = ["Kemayoran", "Halim PK", "Bogor", "Banten", "Katulampa", "Depok", "Manggarai", "Karet", "Setiabudi Timur", "Melati", "Istana", "Krukut Hulu", "Sunter Hulu", "Pesanggrahan", "Angke Hulu", "Tanjungan", "Tomang Barat", "Teluk Gong", "Pulo Gadung", "Sunter Kodamar", "Sunter III Rawa Badak", "Pompa Cideng"];

    window.onload = function() {
        if (localStorage.getItem('gh_token')) {
            document.getElementById('authOverlay').style.display = 'none';
            document.getElementById('mainApp').style.display = 'block';
            fetchGitHubData();
        }
    };

    function login() {
        const pass = document.getElementById('passCode').value;
        const token = document.getElementById('gitToken').value;
        if(pass === "admin123") {
            localStorage.setItem('gh_token', token);
            location.reload();
        } else { alert("Akses Ditolak!"); }
    }

    function logout() { localStorage.clear(); location.reload(); }

    async function fetchGitHubData() {
        try {
            const r = await fetch(`https://api.github.com/repos/${CONFIG.owner}/${CONFIG.repo}/contents/${CONFIG.path}`, {
                headers: { 'Authorization': `token ${localStorage.getItem('gh_token')}` }
            });
            const j = await r.json();
            sha = j.sha;
            allData = JSON.parse(atob(j.content));
            
            // Inisialisasi metadata jika kosong
            if (!allData.find(d => d.type === "metadata")) {
                allData.push({ type: "metadata", coords: {} });
            }

            const sel = document.getElementById('masterStation');
            sel.innerHTML = STATIONS_NAMES.map(name => `<option value="${name}">${name}</option>`).join('');
            
            loadStationData();
        } catch (e) { alert("Gagal tarik data! Cek Token atau File."); }
    }

    function loadStationData() {
        const name = document.getElementById('masterStation').value;
        const meta = allData.find(d => d.type === "metadata");
        const seriesTable = document.getElementById('seriesTable');
        
        // 1. Load Koordinat
        if(meta.coords[name]) {
            document.getElementById('stLat').value = meta.coords[name].lat;
            document.getElementById('stLng').value = meta.coords[name].lng;
        } else {
            document.getElementById('stLat').value = '';
            document.getElementById('stLng').value = '';
        }

        // 2. Load Series Data & Hitung Statistik
        seriesTable.innerHTML = '';
        let values = [];
        
        // Filter data tahunan yang punya nilai untuk stasiun ini
        let stationData = allData.filter(d => d.tahun && d[name] !== undefined);
        stationData.sort((a,b) => b.tahun - a.tahun);

        stationData.forEach(d => {
            let v = parseFloat(d[name]);
            values.push(v);
            seriesTable.innerHTML += `
                <tr>
                    <td>${d.tahun}</td>
                    <td>${v} mm</td>
                    <td style="text-align:right;"><span class="del-text" onclick="deleteData(${d.tahun}, '${name}')">HAPUS</span></td>
                </tr>`;
        });

        // 3. Update Box Statistik
        if(values.length > 0) {
            const avg = values.reduce((a,b) => a+b, 0) / values.length;
            const max = Math.max(...values);
            document.getElementById('statAvg').innerText = avg.toFixed(2) + " mm";
            document.getElementById('statMax').innerText = max.toFixed(1) + " mm";
            document.getElementById('statCount').innerText = values.length + " Tahun";
        } else {
            document.getElementById('statAvg').innerText = "0 mm";
            document.getElementById('statMax').innerText = "0 mm";
            document.getElementById('statCount').innerText = "0 Tahun";
        }
    }

    async function updateStationMeta() {
        const name = document.getElementById('masterStation').value;
        const lat = parseFloat(document.getElementById('stLat').value);
        const lng = parseFloat(document.getElementById('stLng').value);
        
        let meta = allData.find(d => d.type === "metadata");
        meta.coords[name] = { lat, lng };
        await syncToGitHub(`Update Koordinat Stasiun ${name}`);
    }

    async function addNewData() {
        const name = document.getElementById('masterStation').value;
        const yr = parseInt(document.getElementById('newYear').value);
        const val = parseFloat(document.getElementById('newVal').value);

        if(!yr || isNaN(val)) return alert("Input tahun dan nilai!");

        let entry = allData.find(d => d.tahun === yr);
        if(entry) {
            entry[name] = val;
        } else {
            let n = { tahun: yr };
            n[name] = val;
            allData.push(n);
        }
        await syncToGitHub(`Tambah Data Hujan ${name} ${yr}`);
    }

    async function deleteData(yr, name) {
        if(!confirm(`Hapus data ${name} tahun ${yr}?`)) return;
        let entry = allData.find(d => d.tahun === yr);
        if(entry) {
            delete entry[name];
            // Hapus objek tahun jika sudah tidak ada data stasiun manapun di tahun itu
            if(Object.keys(entry).length === 1) {
                allData = allData.filter(d => d.tahun !== yr);
            }
        }
        await syncToGitHub(`Hapus Data ${name} ${yr}`);
    }

    async function syncToGitHub(msg) {
        document.getElementById('loading').style.display = 'flex';
        const res = await fetch(`https://api.github.com/repos/${CONFIG.owner}/${CONFIG.repo}/contents/${CONFIG.path}`, {
            method: 'PUT',
            headers: { 'Authorization': `token ${localStorage.getItem('gh_token')}`, 'Content-Type': 'application/json' },
            body: JSON.stringify({ message: msg, content: btoa(JSON.stringify(allData, null, 2)), sha: sha })
        });
        if(res.ok) location.reload(); else alert("Gagal Sinkron!");
    }
</script>
</body>
</html>
